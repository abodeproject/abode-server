---
- hosts: abode-display
  become_user: root
  become_method: sudo
  tasks:
  - name: Install Git
    apt:
      pkg: git
  - name: Install XServer
    apt:
      pkg: xserver-xorg
  - name: Install xinit
    apt:
      pkg: xinit
  - name: Install mongodb-clients
    apt:
      pkg: mongodb-clients
  - name: Install mongodb-server
    apt:
      pkg: mongodb-server
  - name: Install omxplayer
    apt:
      pkg: omxplayer
  - name: Install gconf-service
    apt:
      pkg: gconf-service
  - name: Install libgtk2.0-0
    apt:
      pkg: libgtk2.0-0
  - name: Install libgnome-keyring0
    apt:
      pkg: libgnome-keyring0
  - name: Install libnspr4
    apt:
      pkg: libnspr4
  - name: Install libnspr4-0d
    apt:
      pkg: libnspr4-0d
  - name: Install libnss3
    apt:
      pkg: libnss3
  - name: Install libxss1
    apt:
      pkg: libxss1
  - name: Install xdg-utils
    apt:
      pkg: xdg-utils
  - name: Install Chromium
    apt:
      pkg: rpi-chromium-mods
  - name: Install Deja Fonts
    apt:
      pkg: fonts-dejavu-core
  - name: Install Dzen2
    apt:
      pkg: dzen2
  - name: Install Apache2
    apt:
      pkg: apache2
  - name: Install libkrb5-dev
    apt:
      pkg: libkrb5-dev
  - name: node init
    notify:
    - Prep NodeJS
    copy:
      src: ansible_files/nodejs.sh
      dest: /tmp/nodejs.sh
      owner: root
      group: root
      mode: 0755
  - meta: flush_handlers
  - name: Install Node
    apt:
      pkg: nodejs
  - name: node forever
    notify:
    - Install Forever
  - name: Install libkrb5-dev
    apt:
      pkg: libkrb5-dev
  - name: Add Scott User
    user:
      name: scott
      uid: 1001
  - name: Add Abode User
    user:
      name: abode
      uid: 1002
      groups: video,input,netdev
  - name: Add Scott Key
    authorized_key:
      user: scott
      key: "{{ lookup('file', '/home/scott/.ssh/id_rsa.pub') }}"
      path: '/home/scott/.ssh/authorized_keys'
      manage_dir: yes
  - name: Scott Sudoers
    lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^scott'
      line: 'scott ALL=(ALL) NOPASSWD: ALL'
  - name: Abobe Sudoers
    lineinfile:
      dest: /etc/sudoers
      state: present
      regexp: '^abode'
      line: 'abode ALL=(ALL) NOPASSWD: /home/abode/abode-server/set_brightness'
  - name: MOTD
    copy:
      src: ansible_files/etc/motd
      dest: /etc/motd
      owner: root
      group: root
      mode: 0644
  - name: Abode Service
    copy:
      src: abode.service
      dest: /lib/systemd/system/abode.service
      owner: root
      group: root
      mode: 0644
  - name: Abode Service Link
    file:
      src: /lib/systemd/system/abode.service
      dest: /etc/systemd/system/abode.service
      state: link
  - name: Abode Monitor Service
    copy:
      src: ansible_files/lib/systemd/system/abode-monitor@.service
      dest: /lib/systemd/system/abode-monitor@.service
      owner: root
      group: root
      mode: 0644
  - name: getty link
    file:
      src: /lib/systemd/system/abode-monitor@.service
      dest: /etc/systemd/system/getty.target.wants/getty@tty1.service
      state: link
  - name: abode bash_profile
    copy:
      src: ansible_files/home/abode/.bash_profile
      dest: /home/abode/.bash_profile
      owner: abode
      group: abode
      mode: 0644
  - name: abode bashrc
    copy:
      src: ansible_files/home/abode/.bashrc
      dest: /home/abode/.bashrc
      owner: abode
      group: abode
      mode: 0644
  - name: abode xsession
    copy:
      src: ansible_files/home/abode/.xsession
      dest: /home/abode/.xsession
      owner: abode
      group: abode
      mode: 0644
  - name: abode start.sh
    copy:
      src: ansible_files/home/abode/start.sh
      dest: /home/abode/start.sh
      owner: abode
      group: abode
      mode: 0755
  - name: scott bashrc
    copy:
      src: /home/scott/.bashrc
      dest: /home/scott/.bashrc
      owner: scott
      group: scott
      mode: 0644
  - name: scott bash_profile
    copy:
      src: /home/scott/.bash_profile
      dest: /home/scott/.bash_profile
      owner: scott
      group: scott
      mode: 0644
  - name: scott bash_profile
    file:
      path: /home/scott/bin
      owner: scott
      group: scott
      mode: 0755
      state: directory
  - name: scott prompt
    copy:
      src: /home/scott/bin/prompt
      dest: /home/scott/bin/prompt
      owner: scott
      group: scott
      mode: 0755
  - name: set_brightness
    copy:
      src: set_brightness
      dest: /usr/local/bin/set_brightness
      owner: root
      group: root
      mode: 0755
  - name: abode apache conf
    notify:
    - Restart HTTPD
    copy:
      src: ansible_files/etc/apache2/sites-available/000-default.conf
      dest: /etc/apache2/sites-available/000-default.conf
      owner: root
      group: root
      mode: 0644
  - name: proxy conf
    notify:
    - Restart HTTPD
    file:
      src: ../mods-available/proxy.conf
      dest: /etc/apache2/mods-enabled/proxy.conf
      state: link
  - name: proxy_http conf
    notify:
    - Restart HTTPD
    file:
      src: ../mods-available/proxy_http.load
      dest: /etc/apache2/mods-enabled/proxy_http.load
      state: link
  - name: proxy.load
    notify:
    - Restart HTTPD
    file:
      src: ../mods-available/proxy.load
      dest: /etc/apache2/mods-enabled/proxy.load
      state: link
  - name: node link
    file:
      src: /usr/bin/nodejs
      dest: /usr/bin/node
      state: link
  - name: Start HTTPD
    tags: httpd
    service:
      name: apache2
      enabled: yes
      state: started
  - name: Start Mongo
    tags: mongo
    service:
      name: mongodb
      enabled: yes
      state: started
  - name: Start Abode
    tags: abode
    service:
      name: abode
      enabled: yes
      state: started
  handlers:
    - name: Restart HTTPD
      service:
        name: apache2
        state: restarted
    - name: Prep NodeJS
      shell: /tmp/nodejs.sh
    - name: Install Forever
      shell: /usr/bin/npm install --global forever
